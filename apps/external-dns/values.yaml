adguard:
  global:
    fullnameOverride: external-dns-adguard
  controllers:
    main:
      enabled: true
      replicas: 1
      containers:
        main: 
          nameOverride: adguard
          image:
            repository: adguard/adguardhome
            tag: v0.107.48
            pullPolicy: IfNotPresent
          env:
            TZ: America/New_York
          args:
            - "--config"
            - "/opt/adguardhome/conf/AdGuardHome.yaml"
            - "--work-dir"
            - "/opt/adguardhome/work"
            - "--no-check-update"
  service:
    main:
      controller: main
      primary: true
      ports:
        http:
          port: 80
        setup:
          port: 3000
        dns:
          port: 53
    dns-tcp:
      controller: main
      annotations:
        metallb.universe.tf/allow-shared-ip: "adguard-dns"
      enabled: true
      type: LoadBalancer
      loadBalancerIP: [{ env "external_dns_lbip" }]
      ports:
        dns-tcp:
          enabled: true
          port: 53
          protocol: TCP
          targetPort: 53
      externalTrafficPolicy: Local
    dns-udp:
      controller: main
      annotations:
        metallb.universe.tf/allow-shared-ip: "adguard-dns"
      enabled: true
      type: LoadBalancer
      loadBalancerIP: [{ env "external_dns_lbip" }]
      ports:
        dns-udp:
          enabled: true
          port: 53
          protocol: UDP
          targetPort: 53
      externalTrafficPolicy: Local
  
  persistence:
    config:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 1Gi
      globalMounts:
        - path: /opt/adguardhome/conf
    data:
      enabled: true
      type: persistentVolumeClaim
      accessMode: ReadWriteOnce
      size: 1Gi
      globalMounts:
        - path: /opt/adguardhome/work

private:
  podLabels:
    app.kubernetes.io/app: external-dns
  crd:
    create: true
  rbac:
    create: true
  provider: webhook
  policy: upsert-only
  labelFilter: access==private
  sources:
    - ingress
[{- if env "custom_internal_dns_records_enabled" }]
    - crd
[{- end }]
  extraArgs:
    webhook-provider-url: http://localhost:8888
  sidecars:
  - name: adguard-webhook
    image: ghcr.io/muhlba91/external-dns-provider-adguard:v5.0.0
    ports:
      - containerPort: 8888
        name: http
    livenessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 30
      timeoutSeconds: 5
    readinessProbe:
      httpGet:
        path: /healthz
        port: http
      initialDelaySeconds: 30
      timeoutSeconds: 5
    env:
      - name: LOG_LEVEL
        value: debug
      - name: ADGUARD_URL
        value: http://external-dns-adguard.external-dns.svc
      - name: ADGUARD_USER
        value: external-dns
      - name: ADGUARD_PASSWORD
        value: password
      - name: SERVER_HOST
        value: "0.0.0.0"
      - name: DRY_RUN
        value: "false"

  customEndpoints: 
    enabled: [{ env "custom_internal_dns_records_enabled" }]
    domain: [{ env "env_domain" }]
    target: [{ env "private_ingress_lbip" }]
    type: "A"
    records: [{- env "custom_internal_dns_records" | nindent 6 }]

public:
  podLabels:
    app.kubernetes.io/app: external-dns
  crd:
    create: true
  rbac:
    create: true
  provider: cloudflare
  cloudflare:
    secretName: [{ env "acme_certs.cloud_secret"}]
    remoteSecret: [{ env "acme_certs.cloud_remoteSecret"}]
    email: [{ env "acme_certs.cloud_email"}]
    proxied: true
  policy: upsert-only
  labelFilter: access==public
  sources:
    - ingress
[{- if env "custom_external_dns_records_enabled" }]
    - crd
[{- end }]
  customEndpoints:
    enabled: [{ env "custom_external_dns_records_enabled" }]
    domain: [{ env "env_domain" }]
    target: [{ env "external_dns_record_target.target" }]
    type: [{ env "external_dns_record_target.type" }]
    records: [{- env "custom_external_dns_records" | nindent 6 }]